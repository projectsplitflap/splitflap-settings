<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Splitflap Display Controller</title>
    <script src="https://unpkg.com/mqtt@4.3.7/dist/mqtt.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://unpkg.com/mqtt@4.3.7/dist/mqtt.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="airport-cycling.js"></script>
<script src="airline-shortener.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: white;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            color: #333;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #667eea;
            font-size: 2.5rem;
            font-weight: 300;
        }

        .status {
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            border-left: 5px solid #667eea;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
            animation: pulse 2s infinite;
        }

        .status-connected {
            background: #28a745;
        }

        .status-disconnected {
            background: #dc3545;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        input[type="text"], input[type="number"], select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 18px;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        input[type="text"]:focus, input[type="number"]:focus, select:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
            display: inline-block;
            text-decoration: none;
            text-align: center;
            min-width: 120px;
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .button:active {
            transform: translateY(0);
        }

        .button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .preset-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .preset-button {
            background: linear-gradient(45deg, #28a745, #20c997);
            padding: 10px 20px;
            font-size: 14px;
            min-width: auto;
        }

        .clear-button {
            background: linear-gradient(45deg, #dc3545, #e83e8c);
        }

        .clock-button {
            background: linear-gradient(45deg, #fd7e14, #ffc107);
        }

        .clock-active {
            background: linear-gradient(45deg, #e63946, #dc3545);
            animation: pulse-button 2s infinite;
        }

        .flight-button {
            background: linear-gradient(45deg, #17a2b8, #6610f2);
        }

        .flight-active {
            background: linear-gradient(45deg, #e63946, #dc3545);
            animation: pulse-button 2s infinite;
        }

        @keyframes pulse-button {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .tabs {
            display: flex;
            margin-top: 40px;
            border-bottom: 2px solid #e9ecef;
        }

        .tab {
            padding: 15px 25px;
            background: #f8f9fa;
            border: none;
            border-radius: 10px 10px 0 0;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 5px;
            color: #6c757d;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
            transform: translateY(-2px);
        }

        .tab:hover:not(.active) {
            background: #e9ecef;
            color: #495057;
        }

        .tab-content {
            display: none;
            padding: 20px 0;
            min-height: 200px;
        }

        .tab-content.active {
            display: block;
        }

        .messages {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            border: 1px solid #e9ecef;
        }

        .message {
            padding: 5px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .message:last-child {
            border-bottom: none;
        }

        .timestamp {
            color: #6c757d;
            font-size: 12px;
        }

        .advanced-settings {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #e9ecef;
        }

        .warning {
            background: linear-gradient(45deg, #ffc107, #fd7e14);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .warning strong {
            display: block;
            margin-bottom: 5px;
        }

        .clock-info {
            background: linear-gradient(45deg, #17a2b8, #6f42c1);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .clock-info strong {
            display: block;
            margin-bottom: 5px;
        }

        .flight-info {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
        }

        .flight-callsign {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            font-family: 'Courier New', monospace;
        }

        .flight-details {
            color: #6c757d;
            font-size: 14px;
            margin-top: 10px;
        }

        .interval-info {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .interval-info .pulse-dot {
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            animation: pulse-dot 2s infinite;
        }

        @keyframes pulse-dot {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.2); }
        }

        small {
            font-size: 12px;
            color: #6c757d;
        }

        .footer {
            text-align: center;
            margin-top: 30px;
            color: #6c757d;
            font-size: 14px;
        }

        @media (max-width: 600px) {
            .container {
                margin: 10px;
                padding: 20px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .button-grid {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                margin-right: 0;
                margin-bottom: 5px;
                border-radius: 10px;
                border-bottom: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔤 Splitflap Controller</h1>
        
        <div class="status">
            <div id="status">
                <span id="statusIndicator" class="status-indicator status-disconnected"></span>
                <strong id="statusText">Connecting...</strong>
            </div>
        </div>

        <div class="input-group">
            <label for="textInput">Text to Display (max 6 characters):</label>
            <input type="text" id="textInput" placeholder="Enter your message..." maxlength="6" autocomplete="off">
        </div>

        <div class="button-grid">
            <button class="button" onclick="sendText()">Send to Display</button>
            <button class="button clear-button" onclick="clearDisplay()">Clear Display</button>
        </div>

        <div class="input-group">
            <label>Quick Messages:</label>
            <div class="preset-buttons">
                <button class="button preset-button" onclick="sendPreset('MATVEY')">MATVEY</button>
                <button class="button preset-button" onclick="sendPreset('PILOT')">PILOT</button>
                <button class="button preset-button" onclick="sendPreset('VIBING')">VIBING</button>
                <button class="button preset-button" onclick="sendPreset('FLYING')">FLYING</button>
                <button class="button preset-button" onclick="sendPreset('TRAVEL')">TRAVEL</button>
                <button class="button preset-button" onclick="sendPreset('HELLO')">HELLO</button>
                <button class="button preset-button" onclick="sendPreset('CANADA')">CANADA</button>
                <button class="button preset-button" onclick="sendPreset('RUSSIA')">RUSSIA</button>
            </div>
        </div>

        <div class="input-group">
            <label>Clock Mode:</label>
            <div class="preset-buttons">
                <button class="button clock-button" id="clockButton" onclick="toggleClock()">🕐 Start Clock</button>
                <select id="timezoneSelect" onchange="updateTimezone()">
                    <option value="America/New_York">EST - Eastern Time</option>
                    <option value="America/Chicago">CST - Central Time</option>
                    <option value="America/Denver">MST - Mountain Time</option>
                    <option value="America/Los_Angeles">PST - Pacific Time</option>
                    <option value="America/Toronto">EST - Toronto</option>
                    <option value="America/Vancouver">PST - Vancouver</option>
                    <option value="Europe/London">GMT - London</option>
                    <option value="Europe/Paris">CET - Paris</option>
                    <option value="Europe/Moscow">MSK - Moscow</option>
                    <option value="Asia/Tokyo">JST - Tokyo</option>
                    <option value="Asia/Shanghai">CST - Beijing</option>
                    <option value="UTC">UTC</option>
                </select>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab(event, 'messages-tab')">📝 Messages</button>
            <button class="tab" onclick="switchTab(event, 'flight-tab')">✈️ Flight Tracker</button>
            <button class="tab" onclick="switchTab(event, 'settings-tab')">⚙️ Settings</button>
        </div>

        <!-- Messages Tab -->
        <div id="messages-tab" class="tab-content active">
            <div class="messages" id="messages">
                <div class="message">
                    <span class="timestamp">[Loading...]</span> Initializing connection...
                </div>
            </div>
        </div>

        <!-- Flight Tracker Tab -->
        <div id="flight-tab" class="tab-content">
            <div class="advanced-settings">
                <h3 style="margin-top: 0; color: #495057;">✈️ Flight Tracker</h3>
                
                <div class="clock-info">
                    <strong>🛩️ Live Flight Tracking with OpenSky Network</strong>
                    Shows the callsign of the closest aircraft to your selected location. Credentials are securely stored in Firebase and automatically loaded when you visit the site.
                </div>

                <div class="input-group">
                    <label for="locationSelect">Track Flights Near:</label>
                    <select id="locationSelect" onchange="updateLocation()">
                        <option value="toronto">🏢 Toronto, ON (43.6532, -79.3832)</option>
                        <option value="wolfville">🍎 Wolfville, NS (45.0918, -64.3643)</option>
                        <option value="waterloo">🎓 Waterloo, ON (43.4643, -80.5204)</option>
                        <option value="vancouver">🌊 Vancouver, BC (49.2827, -123.1207)</option>
                        <option value="nyc">🗽 New York City (40.7128, -74.0060)</option>
                        <option value="yellowknife">💎 Yellowknife, NT (62.4540, -114.3718)</option>
                        <option value="whitehorse">❄️ Whitehorse, YT (60.7212, -135.0568)</option>
                        <option value="moscow">🏛️ Moscow, Russia (55.7558, 37.6176)</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="flightIntervalSelect">Check for Flights Every:</label>
                    <select id="flightIntervalSelect" onchange="updateFlightInterval()">
                        <option value="120000">⚡ 2 minutes (Frequent)</option>
                        <option value="300000" selected>🔄 5 minutes (Normal)</option>
                        <option value="900000">⏰ 15 minutes (Moderate)</option>
                        <option value="1800000">🕐 30 minutes (Conservative)</option>
                    </select>
                    <div id="intervalStatus" class="interval-info" style="display: none;">
                        <div class="pulse-dot"></div>
                        <span id="intervalText">Checking flights every 5 minutes</span>
                    </div>
                </div>

                <div class="input-group">
                    <label>OpenSky Network Setup:</label>
                    <div id="credentialsStatus" style="padding: 10px; border-radius: 5px; margin-bottom: 10px; background: #f8f9fa;">
                        <span id="credentialsStatusText">🔍 Checking for saved credentials...</span>
                    </div>
                    <div id="credentialsForm" style="display: none;">
                        <input type="text" id="openskyUsername" placeholder="OpenSky Username" autocomplete="off">
                        <input type="password" id="openskyPassword" placeholder="OpenSky Password" autocomplete="off">
                        <div style="margin-top: 10px;">
                            <button class="button preset-button" onclick="saveCredentialsToFirebase()">🔐 Save to Firebase</button>
                            <button class="button clear-button" onclick="clearCredentialsFromFirebase()">🗑️ Remove</button>
                        </div>
                    </div>
                    <button class="button" id="setupCredentialsBtn" onclick="showCredentialsForm()" style="display: none;">⚙️ Setup Credentials</button>
                </div>

                <div class="input-group">
                    <label>Flight Tracking Control:</label>
                    <div class="preset-buttons">
                        <button class="button flight-button" id="flightButton" onclick="toggleFlightTracking()">🛩️ Start Flight Tracker</button>
                        <button class="button preset-button" onclick="sendCurrentFlight()">📡 Send Current Flight</button>
                    </div>
                </div>

                <div id="currentFlightInfo" class="flight-info" style="display: none;">
                    <div class="flight-callsign" id="flightCallsign">-</div>
                    <div class="flight-details">
                        <div><strong>Distance:</strong> <span id="flightDistance">-</span></div>
                        <div><strong>Altitude:</strong> <span id="flightAltitude">-</span></div>
                        <div><strong>Country:</strong> <span id="flightCountry">-</span></div>
                        <div><strong>Last Updated:</strong> <span id="flightLastUpdate">-</span></div>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 20px;">
                    <button class="button" onclick="manualFlightUpdate()">🔄 Manual Update</button>
                    <button class="button" onclick="clearFlightData()">🗑️ Clear Flight Data</button>
                </div>
                <div class="input-group" style="margin-top: 30px; border-top: 2px solid #e9ecef; padding-top: 20px;">
                    <label>🇨🇦 Canadian Airport Cycling:</label>
                    <div class="preset-buttons">
                        <button class="button preset-button" id="airportButton" onclick="toggleAirportCycling()">🛬 Start Airport Cycle</button>
                        <select id="airportIntervalSelect" onchange="updateAirportCycleDuration()">
                            <option value="120000" selected>⚡ 2 minutes</option>
                            <option value="300000">🔄 5 minutes</option>
                            <option value="900000">⏰ 15 minutes</option>
                            <option value="1800000">🕐 30 minutes</option>
                        </select>
                    </div>
                    <div id="airportIntervalStatus" class="interval-info" style="display: none;">
                        <div class="pulse-dot"></div>
                        <span id="airportIntervalText">Cycling airports every 2 minutes</span>
                    </div>
                </div>
                
                <div id="currentAirportInfo" class="flight-info" style="display: none;">
                    <div class="flight-callsign" id="airportCode">-</div>
                    <div class="flight-details">
                        <div><strong>Position:</strong> <span id="airportPosition">-</span></div>
                        <div><strong>Type:</strong> Canadian Airport (ICAO)</div>
                        <div><strong>Total Airports:</strong> 267 airports</div>
                        <div><strong>Last Updated:</strong> <span id="airportLastUpdate">-</span></div>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 15px;">
                    <button class="button preset-button" onclick="sendCurrentAirport()">📡 Send Current Airport</button>
                    <button class="button" onclick="clearAirportData()">🗑️ Clear Airport Data</button>
                </div>
            </div>
        </div>

        <!-- Advanced Settings Tab -->
        <div id="settings-tab" class="tab-content">
            <div class="advanced-settings">
                <h3 style="margin-top: 0; color: #495057;">⚙️ Advanced Settings</h3>
                
                <div class="warning">
                    <strong>⚠️ Using Public MQTT Server</strong>
                    Anyone can see your messages on public servers. Consider setting up your own MQTT broker for privacy.
                </div>

                <div class="clock-info">
                    <strong>🕐 Clock Mode Info</strong>
                    When clock mode is active, the display will show the current time (HH MM format) and update every minute. The clock will automatically handle timezone conversion.
                </div>

                <div class="input-group">
                    <label for="mqttServer">MQTT Server:</label>
                    <select id="mqttServer" onchange="updateMQTTServer()">
                        <option value="wss://test.mosquitto.org:8081">test.mosquitto.org (Free, Public)</option>
                        <option value="wss://broker.hivemq.com:8884">broker.hivemq.com (Free, Public)</option>
                        <option value="wss://mqtt.eclipse.org:443/mqtt">mqtt.eclipse.org (Free, Public)</option>
                        <option value="custom">Custom Server...</option>
                    </select>
                </div>

                <div class="input-group" id="customServerGroup" style="display: none;">
                    <label for="customServer">Custom MQTT Server (WSS URL):</label>
                    <input type="text" id="customServer" placeholder="wss://your-mqtt-server.com:8883" autocomplete="off">
                    <small style="color: #6c757d; display: block; margin-top: 5px;">
                        Must be a WebSocket Secure (WSS) URL that supports browser connections
                    </small>
                </div>

                <div class="input-group">
                    <label for="mqttTopic">MQTT Topic:</label>
                    <input type="text" id="mqttTopic" value="splitflap/matvey/command" autocomplete="off">
                    <small style="color: #6c757d; display: block; margin-top: 5px;">
                        This is the MQTT topic your ESP32 is listening to
                    </small>
                </div>

                <div style="text-align: center; margin-top: 20px;">
                    <button class="button" onclick="testConnection()">Test Connection</button>
                    <button class="button" onclick="reconnectMQTT()">Reconnect</button>
                    <button class="button" onclick="resetToDefaults()">Reset to Defaults</button>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>🌐 GitHub Pages Splitflap Controller</p>
            <p>Send messages to your splitflap display from anywhere!</p>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD6kBvuaQ2bZ9lnYog6Doaj_llpIhdrW_U",
            authDomain: "projectsplitflap-7c40b.firebaseapp.com",
            databaseURL: "https://projectsplitflap-7c40b-default-rtdb.firebaseio.com",
            projectId: "projectsplitflap-7c40b",
            storageBucket: "projectsplitflap-7c40b.firebasestorage.app",
            messagingSenderId: "297526631879",
            appId: "1:297526631879:web:cbc57a60cb6bd6243f4de2"
        };

        // Initialize Firebase
        let firebase_initialized = false;
        let database = null;

        function initFirebase() {
            try {
                if (!firebase_initialized && typeof firebase !== 'undefined') {
                    firebase.initializeApp(firebaseConfig);
                    database = firebase.database();
                    firebase_initialized = true;
                    addMessage('🔥 Firebase connected successfully');
                    return true;
                }
            } catch (error) {
                addMessage('⚠️ Firebase error: ' + error.message);
                return false;
            }
            return firebase_initialized;
        }

        // MQTT Configuration
        let MQTT_BROKER = 'wss://test.mosquitto.org:8081';
        let MQTT_TOPIC = 'splitflap/matvey/command';
        
        let mqttClient = null;
        let isConnected = false;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;

        // Clock Configuration
        let clockMode = false;
        let clockInterval = null;
        let selectedTimezone = 'America/New_York';

        // Flight Tracker Configuration
        let flightTrackingMode = false;
        let flightTrackingInterval = null;
        let selectedLocation = 'toronto';
        let currentFlightData = null;
        let openskyCredentials = null; // Will store credentials from Firebase
        let flightCheckInterval = 300000; // Default: 5 minutes

        // Predefined locations with exact coordinates from your Python code
        const locations = {
            toronto: { name: 'Toronto, ON', lat: 43.6532, lon: -79.3832 },
            wolfville: { name: 'Wolfville, NS', lat: 45.0918, lon: -64.3643 },
            waterloo: { name: 'Waterloo, ON', lat: 43.4643, lon: -80.5204 },
            vancouver: { name: 'Vancouver, BC', lat: 49.2827, lon: -123.1207 },
            nyc: { name: 'New York City', lat: 40.7128, lon: -74.0060 },
            yellowknife: { name: 'Yellowknife, NT', lat: 62.4540, lon: -114.3718 },
            whitehorse: { name: 'Whitehorse, YT', lat: 60.7212, lon: -135.0568 },
            moscow: { name: 'Moscow, Russia', lat: 55.7558, lon: 37.6176 }
        };

        // Flight interval options
        const intervalOptions = {
            120000: '2 minutes',
            300000: '5 minutes',
            900000: '15 minutes',
            1800000: '30 minutes'
        };

        // NEW: Text formatting function to ensure exactly 6 characters
        function formatFor6CharDisplay(text) {
    // Convert to uppercase and remove invalid characters
    let formatted = text.toUpperCase().replace(/[^A-Z0-9 ]/g, '');
    
    // Check if this looks like an airline callsign (all letters, 3-4 characters typically)
    // and try to shorten it using our airline mapping
    if (/^[A-Z]{3,4}$/.test(formatted.trim())) {
        const shortened = window.AirlineShortener.getShortAirlineCode(formatted.trim());
        if (shortened && shortened !== formatted.trim()) {
            formatted = shortened;
            console.log(`Airline code shortened: ${text.trim()} -> ${shortened}`);
        }
    }
    
    // Ensure exactly 6 characters
    if (formatted.length > 6) {
        // If too long, take the first 6 characters
        formatted = formatted.substring(0, 6);
    } else if (formatted.length < 6) {
        // If too short, pad with spaces at the end
        formatted = formatted.padEnd(6, ' ');
    }
    
    return formatted;
}

// Enhanced flight display function that prioritizes airline codes
function updateFlightDisplayWithAirlineShortening(flight) {
    if (!flight || !flight.callsign) return;
    
    // Extract potential airline code from callsign (first 3-4 letters typically)
    const callsignMatch = flight.callsign.match(/^([A-Z]{2,4})/);
    
    if (callsignMatch) {
        const airlineCode = callsignMatch[1];
        const shortCode = window.AirlineShortener.getShortAirlineCode(airlineCode);
        
        if (shortCode && shortCode !== airlineCode) {
            // Create a shortened callsign
            const remainingPart = flight.callsign.substring(airlineCode.length);
            const shortenedCallsign = shortCode + remainingPart;
            
            console.log(`Flight callsign shortened: ${flight.callsign} -> ${shortenedCallsign}`);
            
            // Update the flight object with shortened callsign for display
            flight.displayCallsign = shortenedCallsign;
        } else {
            flight.displayCallsign = flight.callsign;
        }
    } else {
        flight.displayCallsign = flight.callsign;
    }
    
    // Use the regular display update function
    updateFlightDisplay(flight);
}

        // Firebase Credential Management
        async function loadCredentialsFromFirebase() {
            if (!firebase_initialized || !database) {
                updateCredentialsStatus('❌ Firebase not connected', 'error');
                return false;
            }

            try {
                const snapshot = await database.ref('config/opensky').once('value');
                const credentials = snapshot.val();
                
                if (credentials && credentials.username && credentials.password) {
                    openskyCredentials = credentials;
                    updateCredentialsStatus('✅ Credentials loaded from Firebase', 'success');
                    return true;
                } else {
                    updateCredentialsStatus('⚙️ No credentials found - setup required', 'warning');
                    document.getElementById('setupCredentialsBtn').style.display = 'inline-block';
                    return false;
                }
            } catch (error) {
                updateCredentialsStatus('❌ Error loading credentials: ' + error.message, 'error');
                return false;
            }
        }

        async function saveCredentialsToFirebase() {
            if (!firebase_initialized || !database) {
                alert('Firebase not connected!');
                return;
            }

            const username = document.getElementById('openskyUsername').value.trim();
            const password = document.getElementById('openskyPassword').value.trim();

            if (!username || !password) {
                alert('Please enter both username and password');
                return;
            }

            try {
                await database.ref('config/opensky').set({
                    username: username,
                    password: password,
                    savedAt: Date.now()
                });

                openskyCredentials = { username, password };
                updateCredentialsStatus('✅ Credentials saved securely to Firebase', 'success');
                hideCredentialsForm();
                addMessage('🔐 OpenSky credentials saved to Firebase');
            } catch (error) {
                alert('Error saving credentials: ' + error.message);
                addMessage('❌ Failed to save credentials: ' + error.message);
            }
        }

        async function clearCredentialsFromFirebase() {
            if (!firebase_initialized || !database) {
                alert('Firebase not connected!');
                return;
            }

            try {
                await database.ref('config/opensky').remove();
                openskyCredentials = null;
                updateCredentialsStatus('⚙️ Credentials removed - setup required', 'warning');
                document.getElementById('setupCredentialsBtn').style.display = 'inline-block';
                addMessage('🗑️ OpenSky credentials removed from Firebase');
            } catch (error) {
                alert('Error removing credentials: ' + error.message);
            }
        }

        function updateCredentialsStatus(message, type) {
            const statusElement = document.getElementById('credentialsStatusText');
            const statusContainer = document.getElementById('credentialsStatus');
            
            statusElement.textContent = message;
            
            // Update styling based on type
            statusContainer.style.background = type === 'success' ? '#d4edda' : 
                                             type === 'error' ? '#f8d7da' : 
                                             type === 'warning' ? '#fff3cd' : '#f8f9fa';
            statusContainer.style.color = type === 'success' ? '#155724' : 
                                         type === 'error' ? '#721c24' : 
                                         type === 'warning' ? '#856404' : '#495057';
        }

        function showCredentialsForm() {
            document.getElementById('credentialsForm').style.display = 'block';
            document.getElementById('setupCredentialsBtn').style.display = 'none';
            document.getElementById('openskyUsername').value = '';
            document.getElementById('openskyPassword').value = '';
        }

        function hideCredentialsForm() {
            document.getElementById('credentialsForm').style.display = 'none';
            document.getElementById('setupCredentialsBtn').style.display = 'none';
            document.getElementById('openskyUsername').value = '';
            document.getElementById('openskyPassword').value = '';
        }

        // Flight interval management
        function updateFlightInterval() {
            const intervalSelect = document.getElementById('flightIntervalSelect');
            const newInterval = parseInt(intervalSelect.value);
            
            if (newInterval !== flightCheckInterval) {
                flightCheckInterval = newInterval;
                const intervalText = intervalOptions[flightCheckInterval];
                
                addMessage(`⏰ Flight check interval updated to ${intervalText}`);
                
                // Update the status display
                const intervalStatus = document.getElementById('intervalStatus');
                const intervalTextElement = document.getElementById('intervalText');
                
                if (flightTrackingMode) {
                    intervalTextElement.textContent = `Checking flights every ${intervalText}`;
                    intervalStatus.style.display = 'flex';
                    
                    // Restart the interval with new timing
                    clearInterval(flightTrackingInterval);
                    flightTrackingInterval = setInterval(fetchFlightData, flightCheckInterval);
                    addMessage(`🔄 Flight tracker restarted with ${intervalText} interval`);
                }
            }
        }

        // Switch between tabs
        function switchTab(evt, tabName) {
            const tabContents = document.getElementsByClassName('tab-content');
            for (let i = 0; i < tabContents.length; i++) {
                tabContents[i].classList.remove('active');
            }
            
            const tabs = document.getElementsByClassName('tab');
            for (let i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove('active');
            }
            
            document.getElementById(tabName).classList.add('active');
            evt.currentTarget.classList.add('active');
            
            const tabText = evt.currentTarget.textContent.trim();
            addMessage(`📂 Switched to ${tabText} tab`);
        }

        // Clock functionality
        function toggleClock() {
            const clockButton = document.getElementById('clockButton');
            
            if (clockMode) {
                clockMode = false;
                clearInterval(clockInterval);
                clockButton.textContent = '🕐 Start Clock';
                clockButton.className = 'button clock-button';
                addMessage('🕐 Clock mode stopped');
            } else {
                if (!isConnected) {
                    alert('Not connected to MQTT broker! Check the Advanced Settings tab.');
                    return;
                }
                
                clockMode = true;
                clockButton.textContent = '⏹️ Stop Clock';
                clockButton.className = 'button clock-button clock-active';
                addMessage(`🕐 Clock mode started (${selectedTimezone})`);
                
                sendCurrentTime();
                clockInterval = setInterval(sendCurrentTime, 60000);
            }
        }

        function sendCurrentTime() {
            if (!isConnected || !clockMode) return;
            
            try {
                const now = new Date();
                const timeString = now.toLocaleTimeString('en-US', {
                    timeZone: selectedTimezone,
                    hour12: false,
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const displayTime = timeString.substring(0, 5).replace(':', ' ');
                const formattedTime = formatFor6CharDisplay(displayTime);
                
                mqttClient.publish(MQTT_TOPIC, formattedTime, { qos: 0 });
                addMessage(`🕐 Clock: ${timeString} (${selectedTimezone}) -> "${formattedTime}"`);
                
            } catch (error) {
                addMessage('❌ Clock error: ' + error.message);
            }
        }

        function updateTimezone() {
            const timezoneSelect = document.getElementById('timezoneSelect');
            selectedTimezone = timezoneSelect.value;
            addMessage(`🌍 Timezone updated to: ${selectedTimezone}`);
            
            if (clockMode) {
                sendCurrentTime();
            }
        }

        // Credential management functions
        function saveCredentials() {
            // Legacy function - now redirects to Firebase
            addMessage('⚠️ Please use the Firebase credential storage in the Flight Tracker tab');
        }

        function clearCredentials() {
            // Legacy function - now redirects to Firebase
            addMessage('⚠️ Please use the Firebase credential storage in the Flight Tracker tab');
        }

        function loadCredentials() {
            // Legacy function - credentials now loaded from Firebase
            return;
        }

        function toggleFlightTracking() {
            const flightButton = document.getElementById('flightButton');
            const intervalStatus = document.getElementById('intervalStatus');
            const intervalText = intervalOptions[flightCheckInterval];
            
            if (flightTrackingMode) {
                flightTrackingMode = false;
                clearInterval(flightTrackingInterval);
                flightButton.textContent = '🛩️ Start Flight Tracker';
                flightButton.className = 'button flight-button';
                intervalStatus.style.display = 'none';
                addMessage('✈️ Flight tracking stopped');
                document.getElementById('currentFlightInfo').style.display = 'none';
            } else {
                if (!isConnected) {
                    alert('Not connected to MQTT broker! Check the Advanced Settings tab.');
                    return;
                }
                
                flightTrackingMode = true;
                flightButton.textContent = '⏹️ Stop Flight Tracker';
                flightButton.className = 'button flight-button flight-active';
                
                // Show interval status
                intervalStatus.style.display = 'flex';
                document.getElementById('intervalText').textContent = `Checking flights every ${intervalText}`;
                
                addMessage(`✈️ Flight tracking started for ${locations[selectedLocation].name}`);
                addMessage(`⏰ Checking for flights every ${intervalText}`);
                
                fetchFlightData();
                flightTrackingInterval = setInterval(fetchFlightData, flightCheckInterval);
            }
        }

        async function fetchFlightData() {
            if (!flightTrackingMode) return;
            
            try {
                addMessage('🔍 Searching for nearby flights...');
                
                const location = locations[selectedLocation];
                const radiusKm = 50; // Same as your Python code
                
                // Use credentials from Firebase if available, otherwise fall back to form inputs
                let username, password;
                if (openskyCredentials) {
                    username = openskyCredentials.username;
                    password = openskyCredentials.password;
                } else {
                    username = document.getElementById('openskyUsername').value || 'jenndryden';
                    password = document.getElementById('openskyPassword').value || 'Happy#12345';
                }
                
                // Calculate bounding box using your exact Python formula
                const latRadius = radiusKm / 111;
                const lonRadius = radiusKm / (111 * Math.cos(location.lat * Math.PI / 180));
                
                const bbox = {
                    lamin: location.lat - latRadius,
                    lamax: location.lat + latRadius,
                    lomin: location.lon - lonRadius,
                    lomax: location.lon + lonRadius
                };
                
                addMessage(`📊 Bounding box: ${bbox.lamin.toFixed(4)}, ${bbox.lamax.toFixed(4)}, ${bbox.lomin.toFixed(4)}, ${bbox.lomax.toFixed(4)}`);
                
                // Call OpenSky API with authentication
                const openskyUrl = `https://opensky-network.org/api/states/all?lamin=${bbox.lamin}&lamax=${bbox.lamax}&lomin=${bbox.lomin}&lomax=${bbox.lomax}`;
                
                addMessage('📡 Fetching data from OpenSky Network...');
                
                // Create authenticated request
                const headers = new Headers();
                headers.append('Authorization', 'Basic ' + btoa(username + ':' + password));
                
                const response = await fetch(openskyUrl, {
                    method: 'GET',
                    headers: headers
                });
                
                if (!response.ok) {
                    throw new Error(`OpenSky API error: ${response.status} - ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (!data.states || data.states.length === 0) {
                    addMessage('❌ No flights found in the area');
                    document.getElementById('currentFlightInfo').style.display = 'none';
                    
                    const clearText = formatFor6CharDisplay('');
                    mqttClient.publish(MQTT_TOPIC, clearText, { qos: 0 });
                    addMessage(`📤 Cleared display - no flights nearby -> "${clearText}"`);
                    return;
                }
                
                addMessage(`📊 Found ${data.states.length} flights in bounding box`);
                
                // Process flights using your exact Python logic
                let closestFlight = null;
                let minDistance = Infinity;
                
                for (const state of data.states) {
                    const [icao24, callsign, origin_country, , , longitude, latitude, baro_altitude, , velocity, true_track, , , geo_altitude] = state;
                    
                    if (longitude === null || latitude === null) continue;
                    
                    // Calculate distance using your exact haversine formula
                    const distance = calculateDistance(location.lat, location.lon, latitude, longitude);
                    
                    if (distance <= radiusKm && distance < minDistance) {
                        minDistance = distance;
                        closestFlight = {
                            icao24: icao24,
                            callsign: (callsign || icao24 || 'N/A').trim(),
                            country: origin_country || 'Unknown',
                            longitude: longitude,
                            latitude: latitude,
                            altitude: geo_altitude || baro_altitude || 'N/A',
                            velocity: velocity || 'N/A',
                            track: true_track || 'N/A',
                            distance: distance.toFixed(1),
                            lastUpdate: new Date().toLocaleTimeString()
                        };
                    }
                }
                
                if (closestFlight) {
                    currentFlightData = closestFlight;
                    updateFlightDisplay(closestFlight);
                    
                    addMessage(`✈️ Closest flight: ${closestFlight.callsign} at ${closestFlight.distance}km`);
                    
                    // Store in Firebase if connected
                    if (firebase_initialized && database) {
                        await database.ref(`flights/${selectedLocation}`).set({
                            ...closestFlight,
                            timestamp: Date.now()
                        });
                        addMessage('🔥 Flight data saved to Firebase');
                    }
                    
                    // Use enhanced airline shortening for flight display
                updateFlightDisplayWithAirlineShortening(closestFlight);
                
                // Format the display callsign for the splitflap
                const formattedCallsign = formatFor6CharDisplay(closestFlight.displayCallsign || closestFlight.callsign);
                
                mqttClient.publish(MQTT_TOPIC, formattedCallsign, { qos: 0 });
                addMessage(`📤 Sent to display: "${formattedCallsign}" (from ${closestFlight.callsign})`);
                    
                } else {
                    addMessage('❌ No flights found within 50km radius');
                    document.getElementById('currentFlightInfo').style.display = 'none';
                    
                    const clearText = formatFor6CharDisplay('');
                    mqttClient.publish(MQTT_TOPIC, clearText, { qos: 0 });
                    addMessage(`📤 Cleared display - no flights in range -> "${clearText}"`);
                }
                
            } catch (error) {
                addMessage('❌ Flight tracking error: ' + error.message);
                
                if (error.message.includes('CORS') || error.message.includes('fetch')) {
                    addMessage('⚠️ Browser CORS restriction detected.');
                    addMessage('💡 Recommendation: Run your Python script to update Firebase directly.');
                }
            }
        }

        // Calculate distance using your exact Python haversine formula
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            
            const lat1Rad = lat1 * Math.PI / 180;
            const lon1Rad = lon1 * Math.PI / 180;
            const lat2Rad = lat2 * Math.PI / 180;
            const lon2Rad = lon2 * Math.PI / 180;
            
            const dlat = lat2Rad - lat1Rad;
            const dlon = lon2Rad - lon1Rad;
            
            const a = Math.sin(dlat/2) * Math.sin(dlat/2) + 
                     Math.cos(lat1Rad) * Math.cos(lat2Rad) * 
                     Math.sin(dlon/2) * Math.sin(dlon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const distance = R * c;
            
            return distance;
        }

        function updateFlightDisplay(flight) {
            document.getElementById('currentFlightInfo').style.display = 'block';
            document.getElementById('flightCallsign').textContent = flight.callsign;
            document.getElementById('flightDistance').textContent = flight.distance + ' km';
            document.getElementById('flightAltitude').textContent = flight.altitude + (typeof flight.altitude === 'number' ? ' m' : '');
            document.getElementById('flightCountry').textContent = flight.country;
            document.getElementById('flightLastUpdate').textContent = flight.lastUpdate;
        }

        function updateLocation() {
            const locationSelect = document.getElementById('locationSelect');
            selectedLocation = locationSelect.value;
            
            addMessage(`📍 Location updated to: ${locations[selectedLocation].name}`);
            
            if (flightTrackingMode) {
                addMessage('🔄 Restarting flight tracking for new location...');
                fetchFlightData();
            }
        }

        function sendCurrentFlight() {
            if (!currentFlightData) {
                alert('No flight data available! Start flight tracking first.');
                return;
            }
            
            if (!isConnected) {
                alert('Not connected to MQTT broker!');
                return;
            }
            
            const formattedCallsign = formatFor6CharDisplay(currentFlightData.callsign);
            
            mqttClient.publish(MQTT_TOPIC, formattedCallsign, { qos: 0 });
            addMessage(`✈️ Manually sent flight: "${formattedCallsign}"`);
        }

        function manualFlightUpdate() {
            if (!flightTrackingMode) {
                addMessage('⚠️ Flight tracking not active - starting one-time update');
            }
            fetchFlightData();
        }

        function clearFlightData() {
            currentFlightData = null;
            document.getElementById('currentFlightInfo').style.display = 'none';
            addMessage('🗑️ Flight data cleared');
            
            if (firebase_initialized && database) {
                database.ref(`flights/${selectedLocation}`).remove();
                addMessage('🔥 Firebase flight data cleared');
            }
        }

        // MQTT Functions
        function updateMQTTServer() {
            const serverSelect = document.getElementById('mqttServer');
            const customGroup = document.getElementById('customServerGroup');
            
            if (serverSelect.value === 'custom') {
                customGroup.style.display = 'block';
            } else {
                customGroup.style.display = 'none';
                MQTT_BROKER = serverSelect.value;
                if (mqttClient) {
                    addMessage('🔄 Switching to ' + serverSelect.options[serverSelect.selectedIndex].text);
                    reconnectMQTT();
                }
            }
        }

        function applyCustomServer() {
            const customServer = document.getElementById('customServer').value;
            if (customServer && customServer.startsWith('wss://')) {
                MQTT_BROKER = customServer;
                addMessage('🔄 Switching to custom server: ' + customServer);
                reconnectMQTT();
            } else {
                alert('Please enter a valid WSS URL (e.g., wss://your-server.com:8883)');
            }
        }

        function updateTopic() {
            const topicInput = document.getElementById('mqttTopic');
            MQTT_TOPIC = topicInput.value;
            addMessage('📋 Topic updated to: ' + MQTT_TOPIC);
        }

        function reconnectMQTT() {
            if (mqttClient) {
                mqttClient.end(true);
            }
            setTimeout(() => initMQTT(), 1000);
        }

        function resetToDefaults() {
            if (clockMode) {
                toggleClock();
            }
            
            if (flightTrackingMode) {
                toggleFlightTracking();
            }

            if (typeof resetAirportCycling === 'function') {
                resetAirportCycling();
            }
            
            document.getElementById('mqttServer').value = 'wss://test.mosquitto.org:8081';
            document.getElementById('mqttTopic').value = 'splitflap/matvey/command';
            document.getElementById('timezoneSelect').value = 'America/New_York';
            document.getElementById('locationSelect').value = 'toronto';
            document.getElementById('flightIntervalSelect').value = '300000';
            document.getElementById('customServerGroup').style.display = 'none';
            document.getElementById('intervalStatus').style.display = 'none';
            
            MQTT_BROKER = 'wss://test.mosquitto.org:8081';
            MQTT_TOPIC = 'splitflap/matvey/command';
            selectedTimezone = 'America/New_York';
            selectedLocation = 'toronto';
            flightCheckInterval = 300000;
            
            addMessage('🔄 Reset to default settings');
            reconnectMQTT();
        }

        function initMQTT() {
            try {
                addMessage('🔗 Connecting to ' + MQTT_BROKER);
                
                mqttClient = mqtt.connect(MQTT_BROKER, {
                    reconnectPeriod: 5000,
                    connectTimeout: 10000,
                    keepalive: 60
                });
                
                mqttClient.on('connect', function() {
                    isConnected = true;
                    reconnectAttempts = 0;
                    updateStatus('Connected to ' + MQTT_BROKER, true);
                    addMessage('✅ Connected successfully!');
                });
                
                mqttClient.on('error', function(error) {
                    isConnected = false;
                    updateStatus('Connection error: ' + error.message, false);
                    addMessage('❌ MQTT Error: ' + error.message);
                    
                    reconnectAttempts++;
                    if (reconnectAttempts >= maxReconnectAttempts) {
                        addMessage('⚠️ Max reconnection attempts reached. Try switching to a different MQTT server.');
                        reconnectAttempts = 0;
                    }
                });
                
                mqttClient.on('close', function() {
                    isConnected = false;
                    updateStatus('Disconnected from MQTT broker', false);
                    addMessage('⚠️ MQTT connection closed');
                    
                    if (clockMode) {
                        addMessage('⚠️ Clock stopped due to connection loss');
                        toggleClock();
                    }
                    
                    if (flightTrackingMode) {
                        addMessage('⚠️ Flight tracking stopped due to connection loss');
                        toggleFlightTracking();
                    }
                });
                
                mqttClient.on('reconnect', function() {
                    addMessage('🔄 Attempting to reconnect... (attempt ' + (reconnectAttempts + 1) + ')');
                });
                
                mqttClient.on('offline', function() {
                    isConnected = false;
                    updateStatus('MQTT client offline', false);
                    addMessage('📡 MQTT client went offline');
                });
                
            } catch (error) {
                updateStatus('Failed to initialize MQTT: ' + error.message, false);
                addMessage('❌ Failed to initialize MQTT: ' + error.message);
            }
        }

        function updateStatus(text, connected) {
            const statusText = document.getElementById('statusText');
            const statusIndicator = document.getElementById('statusIndicator');
            
            statusText.textContent = text;
            statusIndicator.className = 'status-indicator ' + (connected ? 'status-connected' : 'status-disconnected');
        }

        function addMessage(message) {
            const messagesDiv = document.getElementById('messages');
            const timestamp = new Date().toLocaleTimeString();
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${message}`;
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            while (messagesDiv.children.length > 25) {
                messagesDiv.removeChild(messagesDiv.firstChild);
            }
        }

        function sendText() {
            const textInput = document.getElementById('textInput');
            const text = textInput.value.trim();
            
            if (!text) {
                alert('Please enter some text!');
                return;
            }
            
            if (!isConnected) {
                alert('Not connected to MQTT broker! Check the Advanced Settings tab.');
                return;
            }
            
            if (clockMode) {
                addMessage('🕐 Clock stopped - manual message sent');
                toggleClock();
            }
            
            if (flightTrackingMode) {
                addMessage('✈️ Flight tracking stopped - manual message sent');
                toggleFlightTracking();
            }
            
            try {
                const formattedText = formatFor6CharDisplay(text);
                mqttClient.publish(MQTT_TOPIC, formattedText, { qos: 0 });
                addMessage(`📤 Sent: "${formattedText}" to ${MQTT_TOPIC}`);
                textInput.value = '';
            } catch (error) {
                addMessage('❌ Failed to send message: ' + error.message);
            }
        }

        function sendPreset(text) {
            if (!isConnected) {
                alert('Not connected to MQTT broker! Check the Advanced Settings tab.');
                return;
            }
            
            if (clockMode) {
                addMessage('🕐 Clock stopped - preset message sent');
                toggleClock();
            }
            
            if (flightTrackingMode) {
                addMessage('✈️ Flight tracking stopped - preset message sent');
                toggleFlightTracking();
            }
            
            try {
                const formattedText = formatFor6CharDisplay(text);
                mqttClient.publish(MQTT_TOPIC, formattedText, { qos: 0 });
                addMessage(`📤 Sent: "${formattedText}" to ${MQTT_TOPIC}`);
            } catch (error) {
                addMessage('❌ Failed to send preset: ' + error.message);
            }
        }

        function clearDisplay() {
            if (clockMode) {
                addMessage('🕐 Clock stopped - display cleared');
                toggleClock();
            }
            
            if (flightTrackingMode) {
                addMessage('✈️ Flight tracking stopped - display cleared');
                toggleFlightTracking();
            }
            
            const clearText = formatFor6CharDisplay('');
            if (isConnected) {
                mqttClient.publish(MQTT_TOPIC, clearText, { qos: 0 });
                addMessage(`📤 Display cleared: "${clearText}"`);
            }
        }

        function testConnection() {
            if (!isConnected) {
                addMessage('🔄 Testing connection...');
                initMQTT();
            } else {
                addMessage('✅ Already connected to ' + MQTT_BROKER);
            }
        }

        // Event Listeners
        document.getElementById('textInput').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                sendText();
            }
        });

        document.getElementById('textInput').addEventListener('input', function(event) {
            event.target.value = event.target.value.toUpperCase();
        });

        document.getElementById('mqttTopic').addEventListener('change', updateTopic);

        document.getElementById('customServer').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                applyCustomServer();
            }
        });

        // Initialize when page loads
        window.addEventListener('load', function() {
            addMessage('🚀 Starting Splitflap Controller...');
            addMessage('ℹ️ Ready to send messages to your display!');
            
            initFirebase();
            initMQTT();
            
            // Load credentials from Firebase after a short delay to ensure Firebase is ready
            setTimeout(async () => {
                if (firebase_initialized) {
                    await loadCredentialsFromFirebase();
                }
            }, 1000);
        });
    </script>
</body>
</html>