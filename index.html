<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Splitflap Display Controller</title>
    <script src="https://unpkg.com/mqtt@4.3.7/dist/mqtt.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: white;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            color: #333;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #667eea;
            font-size: 2.5rem;
            font-weight: 300;
        }

        .status {
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            border-left: 5px solid #667eea;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
            animation: pulse 2s infinite;
        }

        .status-connected {
            background: #28a745;
        }

        .status-disconnected {
            background: #dc3545;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        input[type="text"], select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 18px;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        input[type="text"]:focus, select:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
            display: inline-block;
            text-decoration: none;
            text-align: center;
            min-width: 120px;
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .button:active {
            transform: translateY(0);
        }

        .button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .preset-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .preset-button {
            background: linear-gradient(45deg, #28a745, #20c997);
            padding: 10px 20px;
            font-size: 14px;
            min-width: auto;
        }

        .clear-button {
            background: linear-gradient(45deg, #dc3545, #e83e8c);
        }

        .clock-button {
            background: linear-gradient(45deg, #fd7e14, #ffc107);
        }

        .clock-active {
            background: linear-gradient(45deg, #e63946, #dc3545);
            animation: pulse-button 2s infinite;
        }

        @keyframes pulse-button {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .tabs {
            display: flex;
            margin-top: 40px;
            border-bottom: 2px solid #e9ecef;
        }

        .tab {
            padding: 15px 25px;
            background: #f8f9fa;
            border: none;
            border-radius: 10px 10px 0 0;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 5px;
            color: #6c757d;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
            transform: translateY(-2px);
        }

        .tab:hover:not(.active) {
            background: #e9ecef;
            color: #495057;
        }

        .tab-content {
            display: none;
            padding: 20px 0;
            min-height: 200px;
        }

        .tab-content.active {
            display: block;
        }

        .messages {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            border: 1px solid #e9ecef;
        }

        .message {
            padding: 5px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .message:last-child {
            border-bottom: none;
        }

        .timestamp {
            color: #6c757d;
            font-size: 12px;
        }

        .advanced-settings {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #e9ecef;
        }

        .warning {
            background: linear-gradient(45deg, #ffc107, #fd7e14);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .warning strong {
            display: block;
            margin-bottom: 5px;
        }

        .clock-info {
            background: linear-gradient(45deg, #17a2b8, #6f42c1);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .clock-info strong {
            display: block;
            margin-bottom: 5px;
        }

        small {
            font-size: 12px;
            color: #6c757d;
        }

        .footer {
            text-align: center;
            margin-top: 30px;
            color: #6c757d;
            font-size: 14px;
        }

        @media (max-width: 600px) {
            .container {
                margin: 10px;
                padding: 20px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .button-grid {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                margin-right: 0;
                margin-bottom: 5px;
                border-radius: 10px;
                border-bottom: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî§ Splitflap Controller</h1>
        
        <div class="status">
            <div id="status">
                <span id="statusIndicator" class="status-indicator status-disconnected"></span>
                <strong id="statusText">Connecting...</strong>
            </div>
        </div>

        <div class="input-group">
            <label for="textInput">Text to Display (max 6 characters):</label>
            <input type="text" id="textInput" placeholder="Enter your message..." maxlength="6" autocomplete="off">
        </div>

        <div class="button-grid">
            <button class="button" onclick="sendText()">Send to Display</button>
            <button class="button clear-button" onclick="clearDisplay()">Clear Display</button>
        </div>

        <div class="input-group">
            <label>Quick Messages:</label>
            <div class="preset-buttons">
                <button class="button preset-button" onclick="sendPreset('MATVEY')">MATVEY</button>
                <button class="button preset-button" onclick="sendPreset('PILOT')">PILOT</button>
                <button class="button preset-button" onclick="sendPreset('VIBING')">VIBING</button>
                <button class="button preset-button" onclick="sendPreset('HELLO')">HELLO</button>
                <button class="button preset-button" onclick="sendPreset('CANADA')">CANADA</button>
                <button class="button preset-button" onclick="sendPreset('RUSSIA')">RUSSIA</button>
            </div>
        </div>

        <div class="input-group">
            <label>Clock Mode:</label>
            <div class="preset-buttons">
                <button class="button clock-button" id="clockButton" onclick="toggleClock()">üïê Start Clock</button>
                <select id="timezoneSelect" onchange="updateTimezone()">
                    <option value="America/New_York">EST - Eastern Time</option>
                    <option value="America/Chicago">CST - Central Time</option>
                    <option value="America/Denver">MST - Mountain Time</option>
                    <option value="America/Los_Angeles">PST - Pacific Time</option>
                    <option value="America/Toronto">EST - Toronto</option>
                    <option value="America/Vancouver">PST - Vancouver</option>
                    <option value="Europe/London">GMT - London</option>
                    <option value="Europe/Paris">CET - Paris</option>
                    <option value="Europe/Moscow">MSK - Moscow</option>
                    <option value="Asia/Tokyo">JST - Tokyo</option>
                    <option value="Asia/Shanghai">CST - Beijing</option>
                    <option value="UTC">UTC</option>
                </select>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab(event, 'messages-tab')">üìù Messages</button>
            <button class="tab" onclick="switchTab(event, 'settings-tab')">‚öôÔ∏è Advanced Settings</button>
        </div>

        <!-- Messages Tab -->
        <div id="messages-tab" class="tab-content active">
            <div class="messages" id="messages">
                <div class="message">
                    <span class="timestamp">[Loading...]</span> Initializing connection...
                </div>
            </div>
        </div>

        <!-- Advanced Settings Tab -->
        <div id="settings-tab" class="tab-content">
            <div class="advanced-settings">
                <h3 style="margin-top: 0; color: #495057;">‚öôÔ∏è Advanced Settings</h3>
                
                <div class="warning">
                    <strong>‚ö†Ô∏è Using Public MQTT Server</strong>
                    Anyone can see your messages on public servers. Consider setting up your own MQTT broker for privacy.
                </div>

                <div class="clock-info">
                    <strong>üïê Clock Mode Info</strong>
                    When clock mode is active, the display will show the current time (HH:MM format) and update every minute. The clock will automatically handle timezone conversion.
                </div>

                <div class="input-group">
                    <label for="mqttServer">MQTT Server:</label>
                    <select id="mqttServer" onchange="updateMQTTServer()">
                        <option value="wss://test.mosquitto.org:8081">test.mosquitto.org (Free, Public)</option>
                        <option value="wss://broker.hivemq.com:8884">broker.hivemq.com (Free, Public)</option>
                        <option value="wss://mqtt.eclipse.org:443/mqtt">mqtt.eclipse.org (Free, Public)</option>
                        <option value="custom">Custom Server...</option>
                    </select>
                </div>

                <div class="input-group" id="customServerGroup" style="display: none;">
                    <label for="customServer">Custom MQTT Server (WSS URL):</label>
                    <input type="text" id="customServer" placeholder="wss://your-mqtt-server.com:8883" autocomplete="off">
                    <small style="color: #6c757d; display: block; margin-top: 5px;">
                        Must be a WebSocket Secure (WSS) URL that supports browser connections
                    </small>
                </div>

                <div class="input-group">
                    <label for="mqttTopic">MQTT Topic:</label>
                    <input type="text" id="mqttTopic" value="splitflap/matvey/command" autocomplete="off">
                    <small style="color: #6c757d; display: block; margin-top: 5px;">
                        This is the MQTT topic your ESP32 is listening to
                    </small>
                </div>

                <div style="text-align: center; margin-top: 20px;">
                    <button class="button" onclick="testConnection()">Test Connection</button>
                    <button class="button" onclick="reconnectMQTT()">Reconnect</button>
                    <button class="button" onclick="resetToDefaults()">Reset to Defaults</button>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>üåê GitHub Pages Splitflap Controller</p>
            <p>Send messages to your splitflap display from anywhere!</p>
        </div>
    </div>

    <script>
        // MQTT Configuration
        let MQTT_BROKER = 'wss://test.mosquitto.org:8081';
        let MQTT_TOPIC = 'splitflap/matvey/command';
        
        let mqttClient = null;
        let isConnected = false;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;

        // Clock Configuration
        let clockMode = false;
        let clockInterval = null;
        let selectedTimezone = 'America/New_York'; // Default to EST

        // Switch between tabs
        function switchTab(evt, tabName) {
            // Hide all tab contents
            const tabContents = document.getElementsByClassName('tab-content');
            for (let i = 0; i < tabContents.length; i++) {
                tabContents[i].classList.remove('active');
            }
            
            // Remove active class from all tabs
            const tabs = document.getElementsByClassName('tab');
            for (let i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove('active');
            }
            
            // Show selected tab content and mark tab as active
            document.getElementById(tabName).classList.add('active');
            evt.currentTarget.classList.add('active');
            
            // Log tab switch
            const tabText = evt.currentTarget.textContent.trim();
            addMessage(`üìÇ Switched to ${tabText} tab`);
        }

        // Clock functionality
        function toggleClock() {
            const clockButton = document.getElementById('clockButton');
            
            if (clockMode) {
                // Stop clock
                clockMode = false;
                clearInterval(clockInterval);
                clockButton.textContent = 'üïê Start Clock';
                clockButton.className = 'button clock-button';
                addMessage('üïê Clock mode stopped');
            } else {
                // Start clock
                if (!isConnected) {
                    alert('Not connected to MQTT broker! Check the Advanced Settings tab.');
                    return;
                }
                
                clockMode = true;
                clockButton.textContent = '‚èπÔ∏è Stop Clock';
                clockButton.className = 'button clock-button clock-active';
                addMessage(`üïê Clock mode started (${selectedTimezone})`);
                
                // Send time immediately
                sendCurrentTime();
                
                // Set up interval to send time every minute
                clockInterval = setInterval(sendCurrentTime, 60000);
            }
        }

        function sendCurrentTime() {
            if (!isConnected || !clockMode) return;
            
            try {
                const now = new Date();
                const timeString = now.toLocaleTimeString('en-US', {
                    timeZone: selectedTimezone,
                    hour12: false,
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // Format as HH:MM (6 characters exactly)
                const displayTime = timeString.substring(0, 5).replace(':', ' ');
                
                mqttClient.publish(MQTT_TOPIC, displayTime, { qos: 0 });
                addMessage(`üïê Clock: ${timeString} (${selectedTimezone})`);
                
            } catch (error) {
                addMessage('‚ùå Clock error: ' + error.message);
            }
        }

        function updateTimezone() {
            const timezoneSelect = document.getElementById('timezoneSelect');
            selectedTimezone = timezoneSelect.value;
            addMessage(`üåç Timezone updated to: ${selectedTimezone}`);
            
            // If clock is running, send updated time immediately
            if (clockMode) {
                sendCurrentTime();
            }
        }

        // Update MQTT server selection
        function updateMQTTServer() {
            const serverSelect = document.getElementById('mqttServer');
            const customGroup = document.getElementById('customServerGroup');
            
            if (serverSelect.value === 'custom') {
                customGroup.style.display = 'block';
            } else {
                customGroup.style.display = 'none';
                MQTT_BROKER = serverSelect.value;
                if (mqttClient) {
                    addMessage('üîÑ Switching to ' + serverSelect.options[serverSelect.selectedIndex].text);
                    reconnectMQTT();
                }
            }
        }

        // Apply custom server
        function applyCustomServer() {
            const customServer = document.getElementById('customServer').value;
            if (customServer && customServer.startsWith('wss://')) {
                MQTT_BROKER = customServer;
                addMessage('üîÑ Switching to custom server: ' + customServer);
                reconnectMQTT();
            } else {
                alert('Please enter a valid WSS URL (e.g., wss://your-server.com:8883)');
            }
        }

        // Update MQTT topic
        function updateTopic() {
            const topicInput = document.getElementById('mqttTopic');
            MQTT_TOPIC = topicInput.value;
            addMessage('üìã Topic updated to: ' + MQTT_TOPIC);
        }

        // Reconnect MQTT
        function reconnectMQTT() {
            if (mqttClient) {
                mqttClient.end(true);
            }
            setTimeout(() => initMQTT(), 1000);
        }

        // Reset to default settings
        function resetToDefaults() {
            // Stop clock if running
            if (clockMode) {
                toggleClock();
            }
            
            document.getElementById('mqttServer').value = 'wss://test.mosquitto.org:8081';
            document.getElementById('mqttTopic').value = 'splitflap/matvey/command';
            document.getElementById('timezoneSelect').value = 'America/New_York';
            document.getElementById('customServerGroup').style.display = 'none';
            
            MQTT_BROKER = 'wss://test.mosquitto.org:8081';
            MQTT_TOPIC = 'splitflap/matvey/command';
            selectedTimezone = 'America/New_York';
            
            addMessage('üîÑ Reset to default settings');
            reconnectMQTT();
        }

        // Initialize MQTT connection
        function initMQTT() {
            try {
                addMessage('üîó Connecting to ' + MQTT_BROKER);
                
                // Connect to MQTT broker using WebSocket
                mqttClient = mqtt.connect(MQTT_BROKER, {
                    reconnectPeriod: 5000,
                    connectTimeout: 10000,
                    keepalive: 60
                });
                
                mqttClient.on('connect', function() {
                    isConnected = true;
                    reconnectAttempts = 0;
                    updateStatus('Connected to ' + MQTT_BROKER, true);
                    addMessage('‚úÖ Connected successfully!');
                });
                
                mqttClient.on('error', function(error) {
                    isConnected = false;
                    updateStatus('Connection error: ' + error.message, false);
                    addMessage('‚ùå MQTT Error: ' + error.message);
                    
                    // Try different server if connection fails repeatedly
                    reconnectAttempts++;
                    if (reconnectAttempts >= maxReconnectAttempts) {
                        addMessage('‚ö†Ô∏è Max reconnection attempts reached. Try switching to a different MQTT server.');
                        reconnectAttempts = 0;
                    }
                });
                
                mqttClient.on('close', function() {
                    isConnected = false;
                    updateStatus('Disconnected from MQTT broker', false);
                    addMessage('‚ö†Ô∏è MQTT connection closed');
                    
                    // Stop clock if running when connection is lost
                    if (clockMode) {
                        addMessage('‚ö†Ô∏è Clock stopped due to connection loss');
                        toggleClock();
                    }
                });
                
                mqttClient.on('reconnect', function() {
                    addMessage('üîÑ Attempting to reconnect... (attempt ' + (reconnectAttempts + 1) + ')');
                });
                
                mqttClient.on('offline', function() {
                    isConnected = false;
                    updateStatus('MQTT client offline', false);
                    addMessage('üì° MQTT client went offline');
                });
                
            } catch (error) {
                updateStatus('Failed to initialize MQTT: ' + error.message, false);
                addMessage('‚ùå Failed to initialize MQTT: ' + error.message);
            }
        }

        // Update connection status
        function updateStatus(text, connected) {
            const statusText = document.getElementById('statusText');
            const statusIndicator = document.getElementById('statusIndicator');
            
            statusText.textContent = text;
            statusIndicator.className = 'status-indicator ' + (connected ? 'status-connected' : 'status-disconnected');
        }

        // Add message to log
        function addMessage(message) {
            const messagesDiv = document.getElementById('messages');
            const timestamp = new Date().toLocaleTimeString();
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${message}`;
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            // Keep only last 25 messages
            while (messagesDiv.children.length > 25) {
                messagesDiv.removeChild(messagesDiv.firstChild);
            }
        }

        // Send text to splitflap display
        function sendText() {
            const textInput = document.getElementById('textInput');
            const text = textInput.value.toUpperCase().trim();
            
            if (!text) {
                alert('Please enter some text!');
                return;
            }
            
            if (!isConnected) {
                alert('Not connected to MQTT broker! Check the Advanced Settings tab.');
                return;
            }
            
            // Stop clock mode if user sends manual text
            if (clockMode) {
                addMessage('üïê Clock stopped - manual message sent');
                toggleClock();
            }
            
            try {
                mqttClient.publish(MQTT_TOPIC, text, { qos: 0 });
                addMessage(`üì§ Sent: "${text}" to ${MQTT_TOPIC}`);
                textInput.value = '';
            } catch (error) {
                addMessage('‚ùå Failed to send message: ' + error.message);
            }
        }

        // Send preset message
        function sendPreset(text) {
            if (!isConnected) {
                alert('Not connected to MQTT broker! Check the Advanced Settings tab.');
                return;
            }
            
            // Stop clock mode if user sends preset
            if (clockMode) {
                addMessage('üïê Clock stopped - preset message sent');
                toggleClock();
            }
            
            try {
                mqttClient.publish(MQTT_TOPIC, text, { qos: 0 });
                addMessage(`üì§ Sent: "${text}" to ${MQTT_TOPIC}`);
            } catch (error) {
                addMessage('‚ùå Failed to send preset: ' + error.message);
            }
        }

        // Clear display
        function clearDisplay() {
            // Stop clock mode if user clears display
            if (clockMode) {
                addMessage('üïê Clock stopped - display cleared');
                toggleClock();
            }
            sendPreset('      '); // Send spaces to clear
        }

        // Add connection test button functionality
        function testConnection() {
            if (!isConnected) {
                addMessage('üîÑ Testing connection...');
                initMQTT();
            } else {
                addMessage('‚úÖ Already connected to ' + MQTT_BROKER);
            }
        }

        // Handle Enter key in text input
        document.getElementById('textInput').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                sendText();
            }
        });

        // Auto-convert to uppercase as user types
        document.getElementById('textInput').addEventListener('input', function(event) {
            event.target.value = event.target.value.toUpperCase();
        });

        // Update topic when changed
        document.getElementById('mqttTopic').addEventListener('change', updateTopic);

        // Apply custom server when Enter is pressed
        document.getElementById('customServer').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                applyCustomServer();
            }
        });

        // Initialize when page loads
        window.addEventListener('load', function() {
            addMessage('üöÄ Starting Splitflap Controller...');
            addMessage('‚ÑπÔ∏è Ready to send messages to your display!');
            initMQTT();
        });
    </script>
</body>
</html>